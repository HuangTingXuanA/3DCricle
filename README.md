# 高性能椭圆检测算法 (Ellipse Detection)

[![C++](https://img.shields.io/badge/C++-17-blue.svg)](https://isocpp.org/)
[![OpenCV](https://img.shields.io/badge/OpenCV-4.x-green.svg)](https://opencv.org/)

本仓库实现了一种基于闭合弧段筛选与亚像素精修的高性能椭圆检测算法。该算法能够从复杂背景中实时、高精度地提取项目中的椭圆（如标定板圆点、圆形零件等），并提供亚像素级的参数拟合。

## 🚀 主要功能

- **亚像素精度**：通过径向梯度极值纠正和 Gauss-Newton 优化，实现超越像素级的检测精度。
- **高鲁棒性**：使用 Tukey Loss 抑制异常点（如边缘噪声、遮挡等），确保拟合结果的稳健性。
- **多模式测试**：
  - **单图测试**：通过 `-i` 指定单张图像进行快速验证。
  - **文件夹测试**：通过 `-f` 批量处理指定目录下的所有测试集（默认 `pics` 目录）。
  - **生成器测试**：通过 `-g` 自动生成带真值的仿真图像，量化评估检测率、中心误差和轴长精度。
- **实时可视化**：支持结果窗口显示、缩放保存以及算法中间过程诊断图像（Edge, Arcs, Candidates）输出。

## 🛠️ 算法逻辑流程

算法的核心流程可以概括为以下六个阶段：

### 1. 边缘提取与段合并 (EDSF)
基于边缘直检法 (Edge Drawing) 思路，计算图像梯度并提取锚点。通过搜索策略将锚点连接成连续的边缘段，保留高质量的强边缘。

### 2. 闭合弧段提取
对提取的边缘段进行端点闭合性判定（采用曼哈顿距离）。只有闭合或接近闭合的弧段才被视为潜在的椭圆候选。

### 3. 凸性检查与几何初筛
- **凸性检查**：计算弧段采样点的叉积，确保弧段朝同一方向弯曲，排除锯齿状或复合状的干扰边缘。
- **几何初筛**：根据用户设定的 `minMinorAxis`（最小短轴）和 `minAspectRatio`（最小长短轴比）过滤不符合条件的候选。

### 4. 椭圆初步拟合
使用 OpenCV 的 `cv::fitEllipse` 或最小二乘法对筛选后的弧段进行初次拟合，获取椭圆的 5 参数（中心 x, y，长短轴 a, b，旋转角 φ）。

### 5. 亚像素几何精修 (核心细节)
这是该算法达到高精度的关键步骤：
- **径向梯度纠正**：在初始椭圆的法向方向上进行灰度采样，通过自适应极性（亮/暗）的灰度百分位阈值精确锁定边缘位置，将边缘点坐标修正到亚像素级别。
- **鲁棒优化**：构建点到椭圆的**正交几何距离**残差。使用 Gauss-Newton 迭代求解，并引入 **Tukey Biweight 权重函数** 自动降低偏离较大点的权重。

### 6. 聚类与去重 (NMS)
在多个检测结果中，基于中心距离和轴长差异进行聚类，采用非极大值抑制 (NMS) 保留覆盖率（Coverage Score）最高的检测结果。

## 🔧 核心参数说明

| 参数名称 | 描述 |
| :--- | :--- |
| `gradThresh` | 边缘检测梯度阈值，越小越能检测弱边缘。 |
| `minMinorAxis` | 允许的最小椭圆短轴长度（像素）。 |
| `inlierDist` | 拟合时的内点距离判定范围。 |
| `tukeyConstant` | Tukey Loss 截断常数，控制对噪声的宽容度。 |
| `polarity` | 极性约束（0: 任意, 1: 亮椭圆, -1: 暗椭圆）。 |

## 📦 快速开始

```bash
# 1. 编译
cmake -B build
cmake --build build -j$(nproc)

# 2. 测试图片集
./build/ellipse_detector -f pics

# 3. 指定目录并开启 2 倍缩放显示
./build/ellipse_detector -f ~/my_images -s 2.0

# 4. 开启诊断模式
./build/ellipse_detector -i pics/image_1.bmp -d
# 结果将生成在 debug_diag/ 目录下
```

## 📊 精度验证
使用生成器模式可以量化算法性能：
```bash
./ellipse_detector -g -n 20
```
该模式会输出平均中心误差（像素）、轴长误差以及成功检测率等指标。
